{{- if .Values.dryRun.enabled }}
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: compute-gardener-dryrun
  {{- if .Values.dryRun.webhook.certManager.enabled }}
  annotations:
    cert-manager.io/inject-ca-from: {{ .Release.Namespace }}/compute-gardener-dryrun-webhook-cert
  {{- end }}
webhooks:
- name: dryrun.compute-gardener-scheduler.kubernetes.io
  admissionReviewVersions: ["v1"]
  clientConfig:
    service:
      name: compute-gardener-dryrun-webhook
      namespace: {{ .Release.Namespace }}
      path: /mutate-pod
    {{- if not .Values.dryRun.webhook.certManager.enabled }}
    caBundle: {{ .Values.dryRun.webhook.tls.crt | b64enc }}
    {{- end }}
  rules:
  - operations: ["CREATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
    scope: "Namespaced"
  sideEffects: None
  {{- if .Values.dryRun.mode | eq "annotate" }}
  # In annotate mode, webhook mutates pods by adding annotations
  failurePolicy: Ignore
  {{- else }}
  # In metrics mode, webhook is read-only (no mutations)
  # If it fails, allow pod creation to proceed
  failurePolicy: Ignore
  {{- end }}
  timeoutSeconds: 5
  {{- if .Values.dryRun.watchNamespaces }}
  namespaceSelector:
    matchExpressions:
    - key: kubernetes.io/metadata.name
      operator: In
      values:
      {{- range .Values.dryRun.watchNamespaces }}
      - {{ . }}
      {{- end }}
  {{- end }}
{{- end }}
